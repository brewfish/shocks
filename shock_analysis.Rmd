---
title: "Detecting shocks to global fish production"
author: "Danielle Ferraro, UC Santa Barbara"
date: "`r Sys.Date()`"
output: 
  pdf_document:
    toc: true
    number_sections: true
bibliography: "brewfish.bib"
csl: "fish-and-fisheries.csl"
link_citations: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
```

# Introduction

The purpose of this document is to describe the methods for detecting shocks to fisheries production within the annual, country-level time series that has been collated for Track 1 within the Brewfish project. This code is largely rewritten from the GitHub repository associated with the Cottrell et al. [-@cottrell_food_2019] paper: "Food production shocks across land and sea."

Below is a first cut at rewriting the code. The original code was written to detect shocks across crop and livestock sectors in addition to fisheries and aquaculture sectors. [@cottrell_food_2019] used the Reg Watson marine capture database for fisheries landings in order to account for large-scale, small-scale, and IUU landings, and the FAO FishStat database for inland fisheries landings as well as inland and marine aquaculture production. The major modifications needed to use the code for our purposes will be:

- Use an updated aquaculture time series from FAO Global Production
- Use an updated fisheries time series from FAO Global Production
- Remove time series from other sectors, i.e. crops and livestock

# Setup

Install packages.
```{r packages, include = FALSE, eval = FALSE}

# Rich's
library(party)
library(randomForest)
library(splitstackshape)
library(plyr) # manipulation of data formatting
library(dplyr) # maniuplation of data formatting
library(sp) #spatial tool
library(spatial)
library(classInt)
#library(rworldmap) #if not using ggplot
library(RColorBrewer) #Color Brew Palettes
library(mapproj)
library(sf)#shapefile reading
library(ggalt)
library(ggplot2) #plotting
library(ggforce)
library(rgdal) 
library(ggmap)#creating ggmaps
library(devtools)
library(ggpubr) #for using the ggarrange function (displaying composite ggplots)
library(tidyr)#switching from wide to long format
library(zoo)# moving average functions 
library(countrycode) #adding countrycodes to data
library(colorspace) #adding colour palettes for plots
library(mgcv) #gams
library(car) # linear models
library(ggrepel) #ggrepel labels on point chart
# library(fANCOVA) #loess span fit function 
# library(forecast)
# library(earlywarnings)
# library(Kendall)
library(png)
library(grid) 
# library(readr)
# library(plot3D)
# library(circlize)
library(data.table)
library(purrr)

#Mine
library(here)
library(tidyverse)
library(gridExtra) # for gridding multiple plots
```

Source scripts. 
```{r scripts}
walk(list.files(here("src"), pattern = "\\.R$", full.names = TRUE), source) # Sets file directories
```

# Import data

```{r import data}
country_key <- read_csv(file.path(dir_raw_data, "FAO", "production", "CL_FI_COUNTRY_GROUPS.csv")) 
production <- read_csv(file.path(dir_raw_data, "FAO", "production", "TS_FI_PRODUCTION.csv"), col_types = cols(UNIT = col_character())) %>% 
  rename_all(tolower)
```

# Tidy data

Append country names to production data. 

```{r append country names}
production <- production %>% 
  left_join(country_key[,c("UN_Code", "Name_En")], by = c("country" = "UN_Code")) %>% 
  rename(country_name = Name_En)
```

Evaluate symbols. According to the FAO metadata (also available on NCEAS' Aurora server at `r file.path(dir_raw_data, "FAO", "production", "CL_FI_SYMBOL.csv")`, the different characters in the `SYMBOL` column correspond to the following notes:

Code|Symbol|Name|Description
-----|-----|-----|-----
1|.|UNKNOWN|Data not available; unobtainable; data not separately available but included in another category
2|0|NEGLIGIBLE|More than zero but less than half the unit used
3|-|ZERO|None; magnitude known to be nil or zero
4|F|ESTIMATED|FAO estimate from available sources of information or calculation based on specific assumptions
5|R|REPETITION|Repetition
6| |OFFICIAL|Official Data

```{r transform symbols}
table(production$symbol) # Need to transform the negligibles (symbol=="0") and zeroes (symbol=="-")
production <- production %>% 
  mutate(quantity = case_when(symbol=="0" ~ 0.5,
                              symbol=="-" ~ 0,
                              TRUE ~ quantity))
```

Identify aquaculture vs. capture landings. According to the FAO metadata (also available on NCEAS' Aurora server at `r file.path(dir_raw_data, "FAO", "production", "CL_FI_PRODUCTION_SOURCE.csv")`, the different numbers in the `SOURCE` column correspond to the following types of production:

Identifier|Code|Name
-----|-----|-----
5|AQUACULTURE|Aquaculture production
1|FRESHWATER|Aquaculture production (freshwater)
2|BRACKISHWATER|Aquaculture production (brackishwater)
3|MARINE|Aquaculture production (marine)
4|CAPTURE|Capture production

```{r label capture vs. aquaculture}
production <- production %>% 
  mutate(sector = if_else(source==4, "capture", "aquaculture"))
```

# Calculate aggregate production

Aggregate production per year, per country, per sector.
```{r calc aggregate production}
agg_production <- production %>% 
  group_by(country, country_name, year, sector) %>% 
  summarize(sum_quantity = sum(quantity)) %>% 
  ungroup(country, country_name, year, sector)
```

## Plot production

Create a pdf with aggregated aquaculture and capture production over time by country.
```{r plot agg production, eval = FALSE}
# Turn aggregated production data frame into a list of data frames by country
agg_production_list <- agg_production %>% 
  group_split(country_name)

# Build of list of production vs time plots by country
agg_production_plots <- map(agg_production_list, 
                            ~ggplot(., aes(x = year, y = sum_quantity, color = sector)) + 
                              geom_hline(yintercept = 0, color = "darkgray", linetype = "dashed") +
                              geom_line() +
                              geom_point() +
                              scale_color_manual(values = c("darkred", "darkblue"), 
                                                 labels = c("Aquaculture", "Capture")) +
                              scale_x_continuous(breaks=seq(1950, 2017, 10)) +
                              ylim(0,NA) +
                              labs(title = paste("Fisheries Production in", .$country_name), 
                                   x = "Year", 
                                   y = "Quantity (tonnes)",
                                   color = NULL) +
                              ggpubr::theme_pubr() +
                              theme(legend.text = element_text(size=11))
)

# Write plots to pdf, 3 per page

# A really janky way to build an index of the 1st, 4th, 9th elements of the plot list, minus the last one.
# Could be a better way to do this but it works.
index <- head(seq_along(agg_production_plots)[seq(1, length(agg_production_plots), 3)], -1)

pdf(here("output", "fig_agg_production_bycountry.pdf"), height = 11, width = 8.5)
for(i in index) {
grid.arrange(agg_production_plots[[i]], agg_production_plots[[i+1]], agg_production_plots[[i+2]])
}
dev.off()
```

# Sensitivity Analysis - Cook's Distance (D)

## Identify suitable time series

Select countries with at least 30 years of fish production.
```{r filter countries}
countries <- agg_production %>% 
  filter(sector == "capture") %>% 
  group_by(country, country_name) %>% 
  summarise(min_yr = min(year), # n = 247 countries (incl. "other nei")
            max_yr = max(year),
            ts_len = max_yr-min_yr) %>% 
  ungroup(country, country_name) %>% 
  filter(ts_len >= 30) %>%
  print(n = Inf) %>% 
  pull(country) # n = 212 countries (incl. "other nei")

# Select only capture fisheries data from the countries indentified above, and 
agg_fisheries <- subset(agg_production, 
                        sector == "capture" 
                        & country %in% countries
                        & year >= 1980)
```

## Count number of shocks across a range of Cook's D values

```{r n shocks across Cook's D}
shock_tally <- c() #vector carrying tally of residuals over specified Cook's D
sumofshocksacrossD <- c() #sum of shocks vector per cooks distance value

for(d in D) {
  shock_tally <- c()
  for (i in seq_along(unique(agg_fisheries$country))) {
    dat <- agg_fisheries[agg_fisheries$country == unique(agg_fisheries$country)[i],]
    fit <- loess(sum_quantity ~ year, data = dat, span = 0.6)
    mod.err <- lm(resid(fit)[2:fit$n]~ resid(fit)[1:fit$n-1])
    for (s in seq(1, fit$n-1, by = 1)){
      if (s > 6 & cooks.distance(mod.err)[s] > d){
        Prodaverage <- median(dat$sum_quantity[s],  
                              dat$sum_quantity[s-1], 
                              dat$sum_quantity[s-2], 
                              dat$sum_quantity[s-3], 
                              dat$sum_quantity[s-4], 
                              dat$sum_quantity[s-5], 
                              dat$sum_quantity[s-6])
        Magnitude <- Prodaverage - dat$sum_quantity[s+1]
        if (Magnitude > 0){
          shock_tally<-c(shock_tally,1)
        }
        print(shock_tally)
      }
    }
  }
  sumofshocksacrossD <-c(sumofshocksacrossD, sum(shock_tally))
}

n_shocks <- cbind.data.frame(D, sumofshocksacrossD) 
names(n_shocks) <- c("D", "n_shocks")
(n_shocks)
```

The number of shocks detected depends on the threshold set. Cottrell et al. [-@cottrell_food_2019] used a threshold of 0.3 in their analyses, but they included non-fisheries sectors. The analysis of shocks to fish production only by Gephart et al. [-@gephart_shocks_2017] uses a threshold of 0.35.

```{r plot n shocks, include=FALSE}
# Plot number of shocks vs. Cook's D threshold
ggline(n_shocks, x = "D", y = "n_shocks", 
       xlab = "Cook's D threshold", 
       ylab = "Number of shocks", 
       title = "Number of shocks over a range of Cook's D values",
       plot_type = "l")

ggsave(here("output", "n_shocks_over_D.pdf"), width = 8, height = 6)
```

## Plot shocks

Create a 3 panel plot per country depicting:  
- Total annual capture production with a loess model fit
- Model residuals regressed with lag-1 residuals
- Cook's D values across the time series

```{r}
shocks <- c()
pdf(file = here("output", "cooks_distance_timeseries.pdf"))
for (i in 1:length(unique(agg_fisheries$country))){
  op <- par(mfrow=c(3, 1))
  
  # Aggregated production plot with model fit
  values <- subset(agg_fisheries$sum_quantity, agg_fisheries$country==unique(agg_fisheries$country)[i])
  years <- subset(agg_fisheries$year, agg_fisheries$country==unique(agg_fisheries$country)[i])
  plot(years, values, xlab = "Year", ylab = "Total Production (tonnes)", main = unique(agg_fisheries$country_name)[i], pch = 20, cex = 0.75)
  fit <- loess(values ~ years, span = 0.6)
  lines(years, predict(fit))
  
  # Regress residuals against lag-1 residuals
  errors <- lm(resid(fit)[2:fit$n] ~ resid(fit)[1:fit$n-1])
  plot(resid(fit)[2:fit$n], resid(fit)[1:fit$n-1], pch = 20, xlab = expression("Residuals"[(italic ("t"))]), ylab = expression("Residuals"[(italic("t-1"))]))
  abline(errors)
  
  # Plot Cook's distance and identify outliers in residual regression
  plot(cooks.distance(errors), type = "o", pch = 20, ylab = "Cook's Distance", xlab = "Index", 
       panel.first = abline(h = 0.3, lty = 2, col = "red", lwd = 2))
  par(op)
  
  # Identify the Shock
  shockInd <- which(as.vector(cooks.distance(errors)>0.3))
  shockInd <- shockInd[shockInd > 6]

  if (length(shockInd)>0){
    for (k in 1:length(shockInd)){
      sector <- "Fisheries"
      country <- unique(agg_fisheries$country_name)[i]
      year <- years[shockInd+1][k]
      seven_yr_median <- median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k],values[shockInd-6][k]))#, values[shockInd-7][k], values[shockInd-8][k]))
      abs_magnitude <- seven_yr_median - values[shockInd+1][k]
      prop_magnitude <- 1-((values[shockInd+1][k])/seven_yr_median)
      recovery <- which(values[(shockInd+2)[k]:fit$n] >= (seven_yr_median*0.95))[1]
      data <- cbind.data.frame(sector, country, year, prop_magnitude, abs_magnitude, recovery)
      shocks <- rbind(shocks, data)
      }
    }
  }
dev.off()
summary(shocks)
```









```{r}
agg_aquaculture <- subset(agg_production, sector == "aquaculture" & country %in% countries)
pdf(file = here("output", "cooks_distance_timeseries.pdf"))
for (i in 1:length(unique(agg_aquaculture$country))){
  op <- par(mfrow=c(3, 1))
  
  #Production plot with model fit
  values <- subset(agg_aquaculture$sum_quantity, agg_aquaculture$country==unique(agg_aquaculture$country)[i])
  years<-subset(agg_aquaculture$year, agg_aquaculture$country==unique(agg_aquaculture$country)[i])
  plot(years, values, xlab="Year", ylab="Total Production (tonnes)", main=unique(agg_aquaculture$country_name)[i], pch=20, cex=0.75)
  fit <- loess(values ~ years, span=0.6)
  lines(years, predict(fit))
  
  #regress residuals against lag-1 residuals
  errors <- lm(resid(fit)[2:fit$n] ~ resid(fit)[2:fit$n])
  plot(resid(fit)[2:fit$n], resid(fit)[2:fit$n], pch=20, xlab=expression("Residuals"[(italic ("t"))]), ylab=expression("Residuals"[(italic("t-1"))]))
  abline(errors)
  
  #plot cooks distance and identify outliers in residual regression
  plot(cooks.distance(errors), type="o", pch=20, ylab="Cook's Distance", xlab="Index")
  abline(h=0.3, lty=2, col="red", lwd=2)
  par(op)
  
  #Identify the Shock
  shockInd<-which(as.vector(cooks.distance(errors)>0.3))
  shockInd<-shockInd[shockInd>6]
  

  if (length(shockInd)>0){
    for (k in 1:length(shockInd)){
      Sector <- "aquaculture"
      Country <- unique(agg_aquaculture$country_name)[i]
      Year <- years[shockInd+1][k]
      fiveyearmean<-median(c(values[shockInd][k],values[shockInd-1][k], values[shockInd-2][k], values[shockInd-3][k], values[shockInd-4][k], values[shockInd-5][k],values[shockInd-6][k]))#, values[shockInd-7][k], values[shockInd-8][k]))
      AbsMagnitude <- fiveyearmean-values[shockInd+1][k]
      PropMagnitude <- 1-((values[shockInd+1][k])/fiveyearmean)
      Recovery<-which(values[(shockInd+2)[k]:53]>=(fiveyearmean*0.95))[1]
      data <- cbind.data.frame(Sector, Country, Year, PropMagnitude, AbsMagnitude, Recovery)
      shocks <- rbind(shocks, data)
      }
    }
  }
dev.off()
summary(shocks)

```

# References



